<!DOCTYPE html>
<html>
<body>

<h2>Next Train Demo</h2>
<select id="lineList" onchange = "lineChanged()" >  
<option value=''> ---Choose Line--- </option>
	<option value='TKL'> Tseung Kwan O Line </option>
	<option value='AEL'> Airport Express </option>
	<option value='TCL'> Tung Chung Line </option>
	<option value='TML'> Tuen Ma Line </option>
	<option value='EAL'> East Rail Line </option>

</select>  

<select id="staList" onchange = "stationChanged()" >  

</select>  

<p id="station"></p>
<p strong> Up Direction</p>
<br>
	<p id="UP_Status"></p>
<p id="UP0"></p>
<p id="UP1"></p>
<p id="UP2"></p>
<p id="UP3"></p>
	<p id="UP4"></p>
<br>
<p strong> Down Direction</p>
<br>
	<p id="DOWN_Status"></p>
<p id="DOWN0"></p>
<p id="DOWN1"></p>
<p id="DOWN2"></p>
<p id="DOWN3"></p>
	<p id="DOWN4"></p>




<script>


	var line = 'TKL'
	var sta = ''
	var lineSta = line + '-' + sta
	var request = 'line=' + line + '&sta=' + sta 
	var url = 'https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php?' + request
	
	let stationList = {
		"TKL": {
			"NOP": "North Point",
			"QUB": "Quarry Bay",
			"YAT": "Yau Tong",
			"TIK": "Tiu Keng Leng",
			"TKO": "Tseung Kwan O",
			"LHP": "LOHAS Park",
			"HAH": "Hang Hau",
			"POA": "Po Lam"
		},
		"AEL": {
			"HOK": "Hong Kong",
			"KOW": "Kowloon",
			"TSY": "Tsing Yi",
			"AIR": "Airport",
			"AWE": "AsiaWorld Expo"
		},
		"TCL": {
			"HOK": "Hong Kong",
			"KOW": "Kowloon",
			"OLY": "Olympic",
			"NAC": "Nam Cheong",
			"LAK": "Lai King",
			"TSY": "Tsing Yi",
			"SUN": "Sunny Bay",
			"TUC": "Tung Chung"
		},
		"EAL": {
			"ADM": "Admiralty",
			"EXC": "Exhibition Centre",
			"HUH": "Hung Hom",
			"MKK": "Mong Kok East",
			"KOT": "Kowloon Tong",
			"TAW": "Tai Wai",
			"SHT": "Sha Tin",
			"FOT": "Fo Tan",
			"UNI": "University",
			"TAP": "Tai Po Market",
			"TWO": "Tai Wo",
			"FAN": "Fanling",
			"SHS": "Sheung Shui",
			"LOW": "Lo Wu",
			"LMC": "Lok Ma Chau"
		},
		"TML": {
			"WKS": "Wu Kai Sha",
			"MOS": "Ma On Shan",
			"HEO": "Heng On",
			"TSH": "Tai Shui Hang",
			"SHM": "Shek Mun",
			"CIO": "City One",
			"STW": "Sha Tin Wai",
			"CKT": "Che Kung Temple",
			"TAW": "Tai Wai",
			"HIK": "Hin Keng",
			"DIH": "Diamond Hill",
			"KAT": "Kai Tak",
			"SUW": "Sung Wong Toi",
			"TKW": "To Kwa Wan",
			"HOM": "Ho Man Tin",
			"HUH": "Hung Hom",
			"ETS": "East Tsim Sha Tsui",
			"AUS": "Austin",
			"NAC": "Nam Cheong",
			"MEF": "Mei Foo",
			"TWW": "Tsuen Wan West",
			"KSR": "Kam Sheung Road",
			"YUL": "Yuen Long",
			"LOP": "Long Ping",
			"TIS": "Tin Shui Wai",
			"SIH": "Siu Hong",
			"TUM": "Tuen Mun"
		},
		"KTL": {
			"WHA": "Whampoa",
			"HOM": "Ho Man Tin",
			"YMT": "Yau Ma Tei",
			"MOK": "Mong Kok",
			"PRE": "Prince Edward",
			"SKM": "Shek Kip Mei",
			"KOT": "Kowloon Tong",
			"LOF": "Lok Fu",
			"WTS": "Wong Tai Sin",
			"DIH": "Diamond Hill",
			"CHH": "Choi Hung",
			"KOB": "Kowloon Bay",
			"NTK": "Ngau Tau Kok",
			"KWT": "Kwun Tong",
			"LAT": "Lam Tin",
			"YAT": "Yau Tong",
			"TIK": "Tiu Keng Leng"
		},
		"ISL": {
			"KET": "Kennedy Town",
			"HKU": "HKU",
			"SYP": "Sai Ying Pun",
			"SHW": "Sheung Wan",
			"CEN": "Central",
			"ADM": "Admiralty",
			"WAC": "Wan Chai",
			"CAB": "Causeway Bay",
			"TIH": "Tin Hau",
			"FOH": "Fortress Hill",
			"NOP": "North Point",
			"QUB": "Quarry Bay",
			"TAK": "Tai Koo",
			"SWH": "Sai Wan Ho",
			"SKW": "Shau Kei Wan",
			"HFC": "Heng Fa Chuen",
			"CHW": "Chai Wan"
		},
		"TWL": {
			"CEN": "Central",
			"ADM": "Admiralty",
			"TST": "Tsim Sha Tsui",
			"JOR": "Jordan",
			"YMT": "Yau Ma Tei",
			"MOK": "Mong Kok",
			"PRE": "Prince Edward",
			"SSP": "Sham Shui Po",
			"CSW": "Cheung Sha Wan",
			"LCK": "Lai Chi Kok",
			"MEF": "Mei Foo",
			"LAK": "Lai King",
			"KWF": "Kwai Fong",
			"KWH": "Kwai Hing",
			"TWH": "Tai Wo Hau",
			"TSW": "Tsuen Wan"
		},
		
		"SIL": {
			"ADM": "Admiralty",
			"OCP": "Ocean Park",
			"WCH": "Wong Chuk Hang",
			"LET": "Lei Tung",
			"SOH": "South Horizons"

		}, 
		
		"DRL": {
			"DIS" : "Disneyland Resort",
			"SUN": "Sunny Bay"
		}
	}
	
	let lineList = { 
		"KTL": {
			"fullName": "Kwun Tong Line",
			"enableETA": false
		},
		"TWL": {
			"fullName": "Tseun Wan Line",
			"enableETA": false
		},
		"ISL": {
			"fullName": "Island Line",
			"enableETA": false
		},
		"TKL": {
			"fullName": "Tseung Kwan O Line",
			"enableETA": true
		},
		"SIL": {
			"fullName": "South Island Line",
			"enableETA": false
		},
		"TCL": {
			"fullName": "Tung Chung Line",
			"enableETA": true
		},
		"AEL": {
			"fullName": "Airport Express",
			"enableETA": true
		},
		"DRL": {
			"fullName": "Disneyland Resort Line",
			"enableETA": false
		},
		"EAL": {
			"fullName": "East Rail Line",
			"enableETA": true
		},
		"TML": {
			"fullName": "Tuen Ma Line",
			"enableETA": true
		},
	} 
	
	
	function updateAllVar(){
		lineSta = line + '-' + sta
		request = 'line=' + line + '&sta=' + sta 
		url = 'https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php?' + request
	}

	function callAPI(){
	
	updateAllVar();
		if(sta !== ''){
			fetch(url)
			.then((response) => response.json())
			.then((data) => { handleJSON(data); console.log({ data }); });
		}
	}

	function handleJSON(json) {
		const directions = ["UP", "DOWN"];
		for(const dir of directions){
			if(dir in json.data[lineSta]) {
				for (let i = 0; i < 5; i++) {
					if(i in json.data[lineSta][dir]){
						let elementID = dir + i;
						let ttnt = json.data[lineSta][dir][i]["ttnt"];
						let dest = json.data[lineSta][dir][i]["dest"];
						let plat = json.data[lineSta][dir][i]["plat"];
						let destFullName = stationList[line][dest];
						let timeMessage = "";
						if(ttnt < 1){
							timeMessage = "--now--"
						} else if(ttnt == 1) {
							timeMessage = ttnt + " min"
						} else {
							timeMessage = ttnt + " mins"
						}
						document.getElementById(elementID).innerHTML = destFullName + "	 " + timeMessage + "  at Platform " + plat;
						
					}	
				}
			} else {
				let elementID = dir + "_Status";
				document.getElementById(elementID).innerHTML = "Data not available";
				
			}
		}
	}

	function resetPage(){
		const directions = ["UP", "DOWN"];
		for(const dir of directions){
			let statusElementID = dir + "_Status";
			document.getElementById(statusElementID).innerHTML = ""
			for (let i = 0; i < 5; i++) {
				let elementID = dir + i
				document.getElementById(elementID).innerHTML = ""
			}
		}
	}

  	
	function stationChanged(){

		var staList = document.getElementById("staList");

		sta = staList.value;
		
	
		console.log({ sta });
		loadPage();

	}
	
	function lineChanged(){
		
		var lineList = document.getElementById("lineList");
		line = lineList.value;
		console.log({ line });
		updateStaDropdown();
		resetPage();
	}

	function updateLineDropdown(){
		var enabledLines = []
		for(const lineConcerned in lineList){
		if(lineList[lineConcerned][enableETA] == true){
			enabledLines.push(lineConcerned)
		}
		document.getElementById("lineList").innerHTML = "<option value=''> ---Choose Line--- </option>"
		for (var lineID in enabledLines){
			document.getElementById("lineList").innerHTML += "<option value='" + lineID + "'> " + lineList[lineID]["fullName"] + "</option>"
		}
	}


	function updateStaDropdown(){
		

		var listOfStationsInSelectedLine = stationList[line];
		document.getElementById("staList").innerHTML = "<option value=''> ---Choose station--- </option>"
		for (var staID in listOfStationsInSelectedLine){
	
		document.getElementById("staList").innerHTML += "<option value='" + staID + "'> " + listOfStationsInSelectedLine[staID] + "</option>"
		}
	}
	
	
		
	function loadPage(){
		resetPage();
		callAPI();
		
	}

	
	loadPage();
	updateStaDropdown();

</script>

</body>
</html>
