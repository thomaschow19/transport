<!DOCTYPE html>
<html>
<body>

<h2>Next bus</h2>
<select id="routeDropdown" onchange = "routeChanged()" >  
</select>

<select id="directionDropdown" onchange = "directionChanged()" >  
</select> 
<br>
<select id="stopDropdown" onchange = "stopChanged()" >  
</select> 
<br>
<p id="progressLabel"></p>

<div id="ETADiv">

</div>


<script>

	const directions = ["outbound", "inbound"];
	

	function callRouteAPI(company, route){
		var request =  company + '/' + route 
		var url = 'https://rt.data.gov.hk/v1.1/transport/citybus-nwfb/route/' + request
		var Httpreq = new XMLHttpRequest(); // a new request
   		Httpreq.open("GET",url,false);
   		Httpreq.send(null);
		var response = Httpreq.responseText;
		console.log({ response });
		var json_obj = JSON.parse(response);
		console.log({ json_obj });
    	return json_obj;  
	}

	function callRouteStopAPI(company, route, direction){
		var request =  company + '/' + route + "/" + direction
		var url = 'https://rt.data.gov.hk/v1.1/transport/citybus-nwfb/route-stop/' + request
		var Httpreq = new XMLHttpRequest(); // a new request
   		Httpreq.open("GET",url,false);
   		Httpreq.send(null);
		var response = Httpreq.responseText;
		console.log({ response });
		var json_obj = JSON.parse(response);
		console.log({ json_obj });
    	return json_obj;  
	}

	function callStopAPI(stop){
		var request =  stop
		var url = 'https://rt.data.gov.hk/v1.1/transport/citybus-nwfb/stop/' + request
		var Httpreq = new XMLHttpRequest(); // a new request
   		Httpreq.open("GET",url,false);
   		Httpreq.send(null);
		var response = Httpreq.responseText;
		console.log({ response });
		var json_obj = JSON.parse(response);
		console.log({ json_obj });
    	return json_obj;  
	}


	function callETAAPI(company, stop, route){
		var request =  company + '/' + stop + "/" + route
		var url = 'https://rt.data.gov.hk/v1.1/transport/citybus-nwfb/eta/' + request
		var Httpreq = new XMLHttpRequest(); // a new request
   		Httpreq.open("GET",url,false);
   		Httpreq.send(null);
		var response = Httpreq.responseText;
		console.log({ response });
		var json_obj = JSON.parse(response);
		console.log({ json_obj });
    	return json_obj;
	}



	function loadRoutes(json){
		document.getElementById("routeDropdown").innerHTML = "<option value='' selected disabled>--- Routes ---</option>";
		for(var i in json.data){
				let routeID = json.data[i]["route"];
				let routeOrigin = json.data[i]["orig_tc"];
				let routeDestination = json.data[i]["dest_tc"];
				document.getElementById("routeDropdown").innerHTML += "<option value='" + routeID + "'> " + routeID + " - " + routeOrigin + " - " + routeDestination + "</option>"
				
		}
	}



	

	function loadStops(json){
		document.getElementById("stopDropdown").innerHTML = "<option value='' selected disabled>--- Stops ---</option>";
		for(var i in json.data){
				let stopID = json.data[i]["stop"];
				let stopDetials = callStopAPI(stopID);
				let stopName = stopDetials.data["name_tc"];
				document.getElementById("stopDropdown").innerHTML += "<option value='" + stopID + "'>" + stopName + "</option>"
				
		}
	}

	

	function routeChanged(){
		updateDirections();
	}

	function directionChanged(){
		updateStops();
	}

	function stopChanged(){
		updateETA();
	}



	
	function updateStops(){

		let routeDropdown = document.getElementById("routeDropdown");
		let route = routeDropdown.value;
		let direction = document.getElementById("directionDropdown").value;
		loadStops(callRouteStopAPI("NWFB", route, direction))
	}

	function updateDirections(){
		let directionDropdown = document.getElementById("directionDropdown");
		directionDropdown.innerHTML = "<option value='' selected disabled>--- Directions ---</option>";
		let routeDropdown = document.getElementById("routeDropdown");
		let route = routeDropdown.value;
		for(const dir of directions){
			console.log({ dir });
			let jsonConcerned = callRouteStopAPI("NWFB", route, dir);
			let isValid = decideIfDirectionIsValid(jsonConcerned);
			console.log({ isValid });
			if( isValid == true) {
				directionDropdown.innerHTML += "<option value='" + dir + "'>" + dir + "</option>";
			}
		}
	}

	function decideIfDirectionIsValid(json){
		for(var i in json.data){
			return true
		}
		return false
	}

	function updateETA(){
		let routeDropdown = document.getElementById("routeDropdown");
		let route = routeDropdown.value;
		let stopDropdown = document.getElementById("stopDropdown");
		let stop = stopDropdown.value;
		loadETA(callETAAPI("NWFB",stop,route));
	}

	function loadETA(json){
		document.getElementById("ETADiv").innerHTML = "";
		for(var i in json.data){
				let ETA = json.data[i]["eta"];
				let remark = json.data[i]["rmk_tc"];
				var remarkText = "";
				if(remark != ""){
					remarkText = " - " + remark
				}
				document.getElementById("ETADiv").innerHTML += ETA + remarkText +"<br>"
		}
	}

	
	
	
	loadRoutes(callRouteAPI("NWFB", ""));

</script>

</body>
</html>
